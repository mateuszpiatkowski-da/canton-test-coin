module Fixture.AllocationInstruction where

import Daml.Script
import Coin.Allocation.Instruction qualified as CoinAllInstr
import Fixture.Parties qualified as F.Parties
import Util.ExtraArgs (emptyExtraArgs)
import Allocation.AllocationRequest qualified as Test.AllocReq
import Splice.Api.Token.AllocationRequestV1 qualified as AllocReq
import Splice.Api.Token.AllocationV1 qualified as Alloc
import Splice.Api.Token.AllocationInstructionV1 qualified as AllocInstr
import DA.TextMap qualified as TM
import Fixture.Token qualified as F.Token
import Coin.Util qualified as Util
import Coin.Allocation.Request

data AllocationInstructionFixture = AllocationInstructionFixture with
  allocationCid : ContractId AllocInstr.AllocationInstruction
  anotherAllocationCid : ContractId AllocInstr.AllocationInstruction
  parties : F.Parties.Parties
    deriving (Eq, Show)

-- where (A, B=[..]):
-- A: amount to send to receiver
-- B: sender holdings with given amounts
createAllocationInstruction : (Decimal, [Decimal]) -> (Decimal, [Decimal]) -> Script AllocationInstructionFixture
createAllocationInstruction (senderSendingAmount, senderHoldingAmounts) (anotherSenderSendingAmount, anotherSenderHoldingAmounts) = script do
  parties@F.Parties.Parties{admin, receiver, sender, anotherSender, executor} <- F.Parties.createParties

  -- prepare allocation data via CoinAllocationRequest
  testAllocRequestCid <- Test.AllocReq.testAllocationRequestWithParties F.Parties.Parties{admin, receiver, sender, anotherSender, executor} (senderSendingAmount, anotherSenderSendingAmount)
  Some testAllocRequest <- queryContractId executor testAllocRequestCid
  let allocRequestView = view (toInterface @AllocReq.AllocationRequest testAllocRequest)

  let transferLegs = TM.toList allocRequestView.transferLegs

  Some senderTransferLeg <- submit sender do
    exerciseCmd testAllocRequestCid GetTransferLeg with
      transferLegId = "senderTransferLegId"
      actor = sender
  Some anotherSenderTransferLeg <- submit anotherSender do
    exerciseCmd testAllocRequestCid GetTransferLeg with
      transferLegId = "anotherSenderTransferLegId"
      actor = anotherSender

  let senderAllocation = Alloc.AllocationSpecification with
        settlement = allocRequestView.settlement
        transferLegId = "senderTransferLegId"
        transferLeg = senderTransferLeg
  let anotherSenderAllocation = Alloc.AllocationSpecification with
        settlement = allocRequestView.settlement
        transferLegId = "anotherSenderTransferLegId"
        transferLeg = anotherSenderTransferLeg

  -- create CoinAllocationInstructionFactory
  standaloneCoinFactoryCid <- submit admin do
    createCmd CoinAllInstr.CoinAllocationInstructionFactory with
      admin
      senders = [sender]

  -- test adding new sender
  testFactoryCid <- submit admin do
    exerciseCmd standaloneCoinFactoryCid CoinAllInstr.AddObserver with
      newSenders = [anotherSender]
  let factoryCid = toInterfaceContractId @AllocInstr.AllocationFactory testFactoryCid

  now <- getTime

  -- create tokens as inputs
  senderHoldings <- mapA (fmap Util.testTokenToHoldingCid . F.Token.createTestToken admin sender) senderHoldingAmounts
  anotherSenderHoldings <- mapA (fmap Util.testTokenToHoldingCid . F.Token.createTestToken admin anotherSender) anotherSenderHoldingAmounts

  -- create CoinAllocationInstructions
  factoryAllocationResult <- submit sender do
    exerciseCmd factoryCid AllocInstr.AllocationFactory_Allocate with
      expectedAdmin = admin
      allocation = senderAllocation
      requestedAt = now
      inputHoldingCids = senderHoldings
      extraArgs = emptyExtraArgs
  let allocationCid = factoryAllocationResult.output.allocationInstructionCid

  anotherFactoryAllocationResult <- submit anotherSender do
    exerciseCmd factoryCid AllocInstr.AllocationFactory_Allocate with
      expectedAdmin = admin
      allocation = anotherSenderAllocation
      requestedAt = now
      inputHoldingCids = anotherSenderHoldings
      extraArgs = emptyExtraArgs
  let anotherAllocationCid = anotherFactoryAllocationResult.output.allocationInstructionCid

  pure AllocationInstructionFixture with
    allocationCid
    anotherAllocationCid
    parties
